var t=function(){return t=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},t.apply(this,arguments)};function e(t,e,n,i){return new(n||(n=Promise))((function(a,o){function r(t){try{l(i.next(t))}catch(t){o(t)}}function s(t){try{l(i.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}))}function n(t,e){var n,i,a,o,r={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,i&&(a=2&o[0]?i.return:o[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,o[1])).done)return a;switch(i=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return r.label++,{value:o[1],done:!1};case 5:r.label++,i=o[1],o=[0];continue;case 7:o=r.ops.pop(),r.trys.pop();continue;default:if(!(a=r.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){r=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){r.label=o[1];break}if(6===o[0]&&r.label<a[1]){r.label=a[1],a=o;break}if(a&&r.label<a[2]){r.label=a[2],r.ops.push(o);break}a[2]&&r.ops.pop(),r.trys.pop();continue}o=e.call(t,r)}catch(t){o=[6,t],i=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function i(t,e,n){if(n||2===arguments.length)for(var i,a=0,o=e.length;a<o;a++)!i&&a in e||(i||(i=Array.prototype.slice.call(e,0,a)),i[a]=e[a]);return t.concat(i||Array.prototype.slice.call(e))}var a=function t(e,n){if(e===n)return!0;if(e&&n&&"object"==typeof e&&"object"==typeof n){if(e.constructor!==n.constructor)return!1;var i,a,o;if(Array.isArray(e)){if((i=e.length)!=n.length)return!1;for(a=i;0!=a--;)if(!t(e[a],n[a]))return!1;return!0}if(e.constructor===RegExp)return e.source===n.source&&e.flags===n.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===n.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===n.toString();if((i=(o=Object.keys(e)).length)!==Object.keys(n).length)return!1;for(a=i;0!=a--;)if(!Object.prototype.hasOwnProperty.call(n,o[a]))return!1;for(a=i;0!=a--;){var r=o[a];if(!t(e[r],n[r]))return!1}return!0}return e!=e&&n!=n};function o(t,e){var n=Object.keys(e||{}).filter((function(n){var i=null==t?void 0:t[n],o=null==e?void 0:e[n];return!a(i,o)}));return Object.keys(t||{}).filter((function(t){Object.keys(e||{}).includes(t)||n.push(t)})),Object.keys(n).length?n:null}var r,s;function l(t,e,n){var i="shortString",a=!0;"number"==typeof n&&(i="javaDouble",a=!1),t[i]=t[i]||{},t[i][e]=a?n+"":n}function u(t){return!!t&&"object"==typeof t&&void 0!==t.value}function c(t){return Object.fromEntries(Object.entries(t).map((function(t){var e=t[0],n=t[1];return[e,u(n)?n:{value:n}]})))}function v(e){return t(t({},e),{identity:e.identity?t(t({},e.identity),{traits:c(e.identity.traits||{})}):void 0})}!function(t){t.NONE="NONE",t.DEFAULT_FLAGS="DEFAULT_FLAGS",t.CACHE="CACHE",t.SERVER="SERVER"}(r||(r={}));var d,g=null,h="FLAGSMITH_EVENT",f="https://edge.api.flagsmith.com/api/v1/",p=function(){function p(e){var n=this;this._trigger=null,this._triggerLoadingState=null,this.timestamp=null,this.isLoading=!1,this.eventSource=null,this.getFlags=function(){var e=n,i=e.api,a=e.evaluationContext;n.log("Get Flags"),n.isLoading=!0,n.loadingState.isFetching||n.setLoadingState(t(t({},n.loadingState),{isFetching:!0}));var s="".concat(n.getContext().identity),u=function(e){var i,a,u,c;if(e&&s==="".concat(n.getContext().identity)){var v=e.flags,d=e.traits,g=e.identifier;n.isLoading=!1;var h={},f={};d=d||[],(v=v||[]).forEach((function(t){h[t.feature.name.toLowerCase().replace(/ /g,"_")]={id:t.feature.id,enabled:t.enabled,value:t.feature_state_value}})),d.forEach((function(t){f[t.trait_key.toLowerCase().replace(/ /g,"_")]={transient:t.transient,value:t.trait_value}})),n.oldFlags=t({},n.flags);var p=o(n.oldFlags,h),y=o(null===(i=n.evaluationContext.identity)||void 0===i?void 0:i.traits,f);if((g||Object.keys(f).length)&&(n.evaluationContext.identity=t(t({},n.evaluationContext.identity),{traits:f}),g&&(n.evaluationContext.identity.identifier=g)),n.flags=h,n.updateStorage(),n._onChange(n.oldFlags,{isFromServer:!0,flagsChanged:p,traitsChanged:y},n._loadedState(null,r.SERVER)),n.datadogRum)try{if(n.datadogRum.trackTraits){var m={};Object.keys((null===(a=n.evaluationContext.identity)||void 0===a?void 0:a.traits)||{}).map((function(t){m["flagsmith_trait_"+t]=n.getTrait(t)}));var S=t(t(t({},n.datadogRum.client.getUser()),{id:n.datadogRum.client.getUser().id||(null===(u=n.evaluationContext.identity)||void 0===u?void 0:u.identifier)}),m);n.log("Setting Datadog user",S),n.datadogRum.client.setUser(S)}}catch(t){console.error(t)}if(n.dtrum)try{var C={javaDouble:{},date:{},shortString:{},javaLongOrObject:{}};Object.keys(n.flags).map((function(t){l(C,"flagsmith_value_"+t,n.getValue(t,{skipAnalytics:!0})),l(C,"flagsmith_enabled_"+t,n.hasFeature(t,{skipAnalytics:!0}))})),Object.keys((null===(c=n.evaluationContext.identity)||void 0===c?void 0:c.traits)||{}).map((function(t){l(C,"flagsmith_trait_"+t,n.getTrait(t))})),n.log("Sending javaLongOrObject traits to dynatrace",C.javaLongOrObject),n.log("Sending date traits to dynatrace",C.date),n.log("Sending shortString traits to dynatrace",C.shortString),n.log("Sending javaDouble to dynatrace",C.javaDouble),n.dtrum.sendSessionProperties(C.javaLongOrObject,C.date,C.shortString,C.javaDouble)}catch(t){console.error(t)}}};return a.identity?Promise.all([a.identity.traits&&Object.keys(a.identity.traits).length||!a.identity.identifier?n.getJSON(i+"identities/","POST",JSON.stringify({identifier:a.identity.identifier,transient:a.identity.transient,traits:Object.entries(a.identity.traits).map((function(t){var e=t[0],n=t[1];return{trait_key:e,trait_value:null==n?void 0:n.value,transient:null==n?void 0:n.transient}})).filter((function(t){return void 0!==t.trait_value||(n.log("Warning - attempted to set an undefined trait value for key",t.trait_key),!1)}))})):n.getJSON(i+"identities/?identifier="+encodeURIComponent(a.identity.identifier)+(a.identity.transient?"&transient=true":""))]).then((function(e){return n.evaluationContext.identity=t(t({},n.evaluationContext.identity),{traits:{}}),u(null==e?void 0:e[0])})).catch((function(t){var e=t.message,n=new Error(e);return Promise.reject(n)})):n.getJSON(i+"flags/").then((function(t){return u({flags:t,traits:void 0})}))},this.analyticsFlags=function(){var e=n.api;if(n.evaluationEvent&&n.evaluationContext.environment&&n.evaluationEvent[n.evaluationContext.environment.apiKey])return n.evaluationEvent&&0!==Object.getOwnPropertyNames(n.evaluationEvent).length&&0!==Object.getOwnPropertyNames(n.evaluationEvent[n.evaluationContext.environment.apiKey]).length?n.getJSON(e+"analytics/flags/","POST",JSON.stringify(n.evaluationEvent[n.evaluationContext.environment.apiKey])).then((function(e){if(n.evaluationContext.environment){var i=n.getState();n.evaluationEvent||(n.evaluationEvent={}),n.evaluationEvent[n.evaluationContext.environment.apiKey]={},n.setState(t(t({},i),{evaluationEvent:n.evaluationEvent})),n.updateEventStorage()}})).catch((function(t){n.log("Exception fetching evaluationEvent",t)})):void 0},this.datadogRum=null,this.loadingState={isLoading:!0,isFetching:!0,error:null,source:r.NONE},this.canUseStorage=!1,this.analyticsInterval=null,this.api=null,this.cacheFlags=!1,this.enableAnalytics=!1,this.enableLogs=!1,this.evaluationContext={},this.evaluationEvent=null,this.flags=null,this.getFlagInterval=null,this.headers=null,this.initialised=!1,this.oldFlags=null,this.onChange=null,this.onError=null,this.ticks=null,this.timer=null,this.dtrum=null,this.withTraits=null,this.cacheOptions={ttl:0,skipAPI:!1,loadStale:!1,storageKey:void 0},this.getValue=function(t,e,i){var a=n.flags&&n.flags[t.toLowerCase().replace(/ /g,"_")],o=null;if(a&&(o=a.value),(null==e?void 0:e.skipAnalytics)||i||n.evaluateFlag(t,"VALUE"),null===o&&void 0!==(null==e?void 0:e.fallback))return e.fallback;if(null==e?void 0:e.json)try{return null===o?(n.log("Tried to parse null flag as JSON: "+t),null):JSON.parse(o)}catch(t){return e.fallback}return o},this.getTrait=function(t){var e,i;return(null===(e=n.evaluationContext.identity)||void 0===e?void 0:e.traits)&&(null===(i=n.evaluationContext.identity.traits[t.toLowerCase().replace(/ /g,"_")])||void 0===i?void 0:i.value)},this.getAllTraits=function(){var t;return Object.fromEntries(Object.entries((null===(t=n.evaluationContext.identity)||void 0===t?void 0:t.traits)||{}).map((function(t){var e=t[0],n=t[1];return[e,null==n?void 0:n.value]})))},this.setContext=function(e){var i=v(e);return n.evaluationContext=t(t({},i),{environment:i.environment||n.evaluationContext.environment}),n.initialised?n.getFlags():Promise.resolve()},this.getContext=function(){return n.evaluationContext},this.updateContext=function(e){return n.setContext(t(t({},n.getContext()),e))},this.setTrait=function(e,i){var a;if(n.api)return n.setContext(t(t({},n.evaluationContext),{identity:t(t({},n.evaluationContext.identity),{traits:t(t({},null===(a=n.evaluationContext.identity)||void 0===a?void 0:a.traits),c(Object.fromEntries([[e,i]])))})}))},this.setTraits=function(e){var i;if(n.api)return n.setContext(t(t({},n.evaluationContext),{identity:t(t({},n.evaluationContext.identity),{traits:t(t({},null===(i=n.evaluationContext.identity)||void 0===i?void 0:i.traits),Object.fromEntries(Object.entries(e).map((function(t){var e=t[0],n=t[1];return[e,u(n)?n:{value:n}]}))))})}));console.error("Attempted to "+"setTraits"+" a user before calling flagsmith.init. Call flagsmith.init first, if you wish to prevent it sending a request for flags, call init with preventFetch:true.")},this.hasFeature=function(t,e){var i="object"==typeof e,a=n.flags&&n.flags[t.toLowerCase().replace(/ /g,"_")],o=!1;return!a&&i&&void 0!==e.fallback?o=null==e?void 0:e.fallback:a&&a.enabled&&(o=!0),(i&&!e.skipAnalytics||!e)&&n.evaluateFlag(t,"ENABLED"),o},this.getStorageKey=function(){var t,e;return(null===(t=n.cacheOptions)||void 0===t?void 0:t.storageKey)||"FLAGSMITH_DB_"+(null===(e=n.evaluationContext.environment)||void 0===e?void 0:e.apiKey)},this.getJSON=function(t,e,i){var a,o=n;o.evaluationContext;var r=o.headers,l={method:e||"GET",body:i,cache:"no-cache",headers:{}};n.evaluationContext.environment&&(l.headers["X-Environment-Key"]=n.evaluationContext.environment.apiKey),e&&"GET"!==e&&(l.headers["Content-Type"]="application/json; charset=utf-8"),r&&Object.assign(l.headers,r),s||console.error("Flagsmith: fetch is undefined, please specify a fetch implementation into flagsmith.init to support SSR.");var u="".concat(null===(a=n.evaluationContext.identity)||void 0===a?void 0:a.identifier);return s(t,l).then((function(i){var a,o,r="".concat(null===(a=n.evaluationContext.identity)||void 0===a?void 0:a.identifier);if(u===r){var s=null===(o=i.headers)||void 0===o?void 0:o.get("x-flagsmith-document-updated-at");if(s)try{var l=parseFloat(s);if(isNaN(l))return Promise.reject("Failed to parse x-flagsmith-document-updated-at");n.timestamp=l}catch(t){n.log(t,"Failed to parse x-flagsmith-document-updated-at",s)}return n.log("Fetch response: "+i.status+" "+(e||"GET")+0+t),i.text().then((function(t){var e=t;try{e=JSON.parse(t)}catch(t){}return!e&&i.status&&(e="API Response: ".concat(i.status)),i.status&&i.status>=200&&i.status<300?e:Promise.reject(new Error(e))}))}n.log("Received response with identity mismatch, ignoring response. Requested: ".concat(u,", Current: ").concat(r))}))},this.evaluateFlag=function(t,e){if(n.datadogRum&&(n.datadogRum.client.addFeatureFlagEvaluation?"VALUE"===e?n.datadogRum.client.addFeatureFlagEvaluation("flagsmith_value_"+t,n.getValue(t,{},!0)):n.datadogRum.client.addFeatureFlagEvaluation("flagsmith_enabled_"+t,n.hasFeature(t,!0)):console.error("Flagsmith: Your datadog RUM client does not support the function addFeatureFlagEvaluation, please update it.")),n.enableAnalytics){if(!n.evaluationEvent||!n.evaluationContext.environment)return;n.evaluationEvent[n.evaluationContext.environment.apiKey]||(n.evaluationEvent[n.evaluationContext.environment.apiKey]={}),void 0===n.evaluationEvent[n.evaluationContext.environment.apiKey][t]&&(n.evaluationEvent[n.evaluationContext.environment.apiKey][t]=0),n.evaluationEvent[n.evaluationContext.environment.apiKey][t]+=1}n.updateEventStorage()},this._onChange=function(t,e,i){var a,o;n.setLoadingState(i),null===(a=n.onChange)||void 0===a||a.call(n,t,e,n.loadingState),null===(o=n._trigger)||void 0===o||o.call(n)},s=e.fetch?e.fetch:"undefined"!=typeof fetch?fetch:null===global||void 0===global?void 0:global.fetch,this.canUseStorage="undefined"!=typeof window||!!e.browserlessStorage,this.log("Constructing flagsmith instance "+e),e.eventSource&&(d=e.eventSource),e.AsyncStorage&&(g=e.AsyncStorage)}return p.prototype.init=function(i){var a,l,u;return e(this,void 0,void 0,(function(){var c,d,p,y,m,S,C,b,x,E,O,F,_,w,A,L,j,k,I,T,P,N,R,K,D,U,G,J,V,H,M,W,q=this;return n(this,(function(B){switch(B.label){case 0:c=v(i.evaluationContext||this.evaluationContext),B.label=1;case 1:if(B.trys.push([1,13,,14]),d=i.environmentID,p=i.api,y=void 0===p?f:p,m=i.headers,S=i.onChange,C=i.cacheFlags,b=i.datadogRum,x=i.onError,E=i.defaultFlags,O=i.fetch,F=i.preventFetch,_=i.enableLogs,w=i.enableDynatrace,A=i.enableAnalytics,L=i.realtime,j=i.eventSourceUrl,k=void 0===j?"https://realtime.flagsmith.com/":j,I=i.AsyncStorage,T=i.identity,P=i.traits,N=i.state,R=i.cacheOptions,K=i.angularHttpClient,D=i._trigger,U=i._triggerLoadingState,c.environment=d?{apiKey:d}:c.environment,!c.environment||!c.environment.apiKey)throw new Error("Please provide `evaluationContext.environment` with non-empty `apiKey`");if(c.identity=T||P?{identifier:T,traits:P?Object.fromEntries(Object.entries(P).map((function(t){return[t[0],{value:t[1]}]}))):{}}:c.identity,this.evaluationContext=c,this.api=(Y=y).endsWith("/")?Y:Y+"/",this.headers=m,this.getFlagInterval=null,this.analyticsInterval=null,this.onChange=S,G="Wrong Flagsmith Configuration: preventFetch is true and no defaulFlags provided",this._trigger=D||this._trigger,this._triggerLoadingState=U||this._triggerLoadingState,this.onError=function(e){q.setLoadingState(t(t({},q.loadingState),{isFetching:!1,isLoading:!1,error:e})),null==x||x(e)},this.enableLogs=_||!1,this.cacheOptions=R?{skipAPI:!!R.skipAPI,ttl:R.ttl||0,storageKey:R.storageKey,loadStale:!!R.loadStale}:this.cacheOptions,!this.cacheOptions.ttl&&this.cacheOptions.skipAPI&&console.warn("Flagsmith: you have set a cache ttl of 0 and are skipping API calls, this means the API will not be hit unless you clear local storage."),O&&(s=O),this.enableAnalytics=A||!1,this.flags=Object.assign({},E)||{},this.datadogRum=b||null,this.initialised=!0,this.ticks=1e4,this.timer=this.enableLogs?(new Date).valueOf():null,this.cacheFlags=void 0!==g&&!!C,h="FLAGSMITH_EVENT_"+c.environment.apiKey,I&&(g=I),L&&"undefined"!=typeof window&&this.setupRealtime(k,c.environment.apiKey),Object.keys(this.flags).length&&(this.loadingState=t(t({},this.loadingState),{isLoading:!1,source:r.DEFAULT_FLAGS})),this.setState(N),this.log("Initialising with properties",i,this),w&&("undefined"==typeof dtrum?console.error("You have attempted to enable dynatrace but dtrum is undefined, please check you have the Dynatrace RUM JavaScript API installed."):this.dtrum=dtrum),K&&(s=function(t){return function(e,n){var i=n.headers,a=n.method,o=n.body;return new Promise((function(n){switch(a){case"GET":return t.get(e,{headers:i}).subscribe((function(t){n({ok:!0,text:function(){return Promise.resolve(t)}})}));case"POST":case"PUT":return t.post(e,o,{headers:i}).subscribe((function(t){n({ok:!0,text:function(){return Promise.resolve(t)}})}))}}))}}(K)),g&&this.canUseStorage&&g.getItem(h).then((function(t){try{q.evaluationEvent=JSON.parse(t)||{}}catch(t){q.evaluationEvent={}}q.analyticsInterval=setInterval(q.analyticsFlags,q.ticks)})),this.enableAnalytics&&(this.analyticsInterval&&clearInterval(this.analyticsInterval),g&&this.canUseStorage&&g.getItem(h,(function(e,n){if(n&&q.evaluationContext.environment){var i=JSON.parse(n);if(i[q.evaluationContext.environment.apiKey]){var a=q.getState();q.log("Retrieved events from cache",n),q.setState(t(t({},a),{evaluationEvent:i[q.evaluationContext.environment.apiKey]}))}}}))),!C)return[3,9];if(!g||!this.canUseStorage)return[3,8];J=function(i,a){return e(q,void 0,void 0,(function(){var e,i,s,l,u,c,d,g,h,f,p,y,m,S,C,b,x,O,_,w=this;return n(this,(function(n){switch(n.label){case 0:if(!a)return[3,7];e=null,i=null,n.label=1;case 1:return n.trys.push([1,5,,6]),s=JSON.parse(a),l=!1,u=!1,s&&s.api===this.api&&(null===(f=null===(h=s.evaluationContext)||void 0===h?void 0:h.environment)||void 0===f?void 0:f.apiKey)===(null===(p=this.evaluationContext.environment)||void 0===p?void 0:p.apiKey)&&(c=!0,this.evaluationContext.identity&&(null===(m=null===(y=s.evaluationContext)||void 0===y?void 0:y.identity)||void 0===m?void 0:m.identifier)!==this.evaluationContext.identity.identifier&&(this.log("Ignoring cache, identity has changed from "+(null===(C=null===(S=s.evaluationContext)||void 0===S?void 0:S.identity)||void 0===C?void 0:C.identifier)+" to "+this.evaluationContext.identity.identifier),c=!1),this.cacheOptions.ttl&&(!s.ts||(new Date).valueOf()-s.ts>this.cacheOptions.ttl)&&(s.ts&&!this.cacheOptions.loadStale?(this.log("Ignoring cache, timestamp is too old ts:"+s.ts+" ttl: "+this.cacheOptions.ttl+" time elapsed since cache: "+((new Date).valueOf()-s.ts)+"ms"),c=!1):s.ts&&this.cacheOptions.loadStale&&(this.log("Loading stale cache, timestamp ts:"+s.ts+" ttl: "+this.cacheOptions.ttl+" time elapsed since cache: "+((new Date).valueOf()-s.ts)+"ms"),u=!0,c=!0)),c&&(l=!0,e=o(this.flags,s.flags),this.setState(t(t({},s),{evaluationContext:v(t(t({},s.evaluationContext),{identity:(null===(b=s.evaluationContext)||void 0===b?void 0:b.identity)?t(t({},null===(x=s.evaluationContext)||void 0===x?void 0:x.identity),{traits:t({},P||{})}):void 0}))})),this.log("Retrieved flags from cache",s))),l?(d=!F&&(!this.cacheOptions.skipAPI||u),this._onChange(null,{isFromServer:!1,flagsChanged:e,traitsChanged:i},this._loadedState(null,r.CACHE,d)),this.oldFlags=this.flags,this.cacheOptions.skipAPI&&l&&!u&&this.log("Skipping API, using cache"),d&&this.getFlags().catch((function(t){var e;null===(e=w.onError)||void 0===e||e.call(w,t)})),[3,4]):[3,2];case 2:return F?[3,4]:[4,this.getFlags()];case 3:n.sent(),n.label=4;case 4:return[3,6];case 5:return g=n.sent(),this.log("Exception fetching cached logs",g),[3,6];case 6:return[3,10];case 7:return F?[3,9]:[4,this.getFlags()];case 8:return n.sent(),[3,10];case 9:if(E)this._onChange(null,{isFromServer:!1,flagsChanged:o({},this.flags),traitsChanged:o({},null===(O=this.evaluationContext.identity)||void 0===O?void 0:O.traits)},this._loadedState(null,r.DEFAULT_FLAGS));else{if(!this.flags)throw new Error(G);this._onChange(null,{isFromServer:!1,flagsChanged:o({},this.flags),traitsChanged:o({},null===(_=this.evaluationContext.identity)||void 0===_?void 0:_.traits)},this._loadedState(null,r.DEFAULT_FLAGS))}n.label=10;case 10:return[2]}}))}))},B.label=2;case 2:return B.trys.push([2,7,,8]),g.getItemSync?(V=g.getItemSync(this.getStorageKey()),[3,5]):[3,3];case 3:return[4,g.getItem(this.getStorageKey())];case 4:V=B.sent(),B.label=5;case 5:return[4,J(null,V)];case 6:case 7:return B.sent(),[3,8];case 8:return[3,12];case 9:return F?[3,11]:[4,this.getFlags()];case 10:return B.sent(),[3,12];case 11:if(E)this._onChange(null,{isFromServer:!1,flagsChanged:o({},E),traitsChanged:o({},null===(a=c.identity)||void 0===a?void 0:a.traits)},this._loadedState(null,r.DEFAULT_FLAGS));else if(this.flags&&(H=null,0===Object.keys(this.flags).length&&(H=G),this._onChange(null,{isFromServer:!1,flagsChanged:o({},this.flags),traitsChanged:o({},null===(l=c.identity)||void 0===l?void 0:l.traits)},this._loadedState(H,r.DEFAULT_FLAGS)),H))throw new Error(H);B.label=12;case 12:return[3,14];case 13:throw M=B.sent(),this.log("Error during initialisation ",M),W=M instanceof Error?M:new Error("".concat(M)),null===(u=this.onError)||void 0===u||u.call(this,W),M;case 14:return[2]}var Y}))}))},p.prototype.getAllFlags=function(){return this.flags},p.prototype.identify=function(t,e,n){return this.evaluationContext.identity={identifier:t,transient:n,traits:this.evaluationContext.identity&&this.evaluationContext.identity.identifier==t?this.evaluationContext.identity.traits:{}},this.evaluationContext.identity.identifier=t,this.log("Identify: "+this.evaluationContext.identity.identifier),e&&(this.evaluationContext.identity.traits=Object.fromEntries(Object.entries(e).map((function(t){var e=t[0],n=t[1];return[e,u(n)?n:{value:n}]})))),this.initialised?this.getFlags():Promise.resolve()},p.prototype.getState=function(){return{api:this.api,flags:this.flags,ts:this.ts,evaluationContext:this.evaluationContext,evaluationEvent:this.evaluationEvent}},p.prototype.setState=function(t){t&&(this.initialised=!0,this.api=t.api||this.api||f,this.flags=t.flags||this.flags,this.evaluationContext=t.evaluationContext||this.evaluationContext,this.evaluationEvent=t.evaluationEvent||this.evaluationEvent,this.log("setState called",this))},p.prototype.logout=function(){return this.evaluationContext.identity=null,this.initialised?this.getFlags():Promise.resolve()},p.prototype.startListening=function(t){void 0===t&&(t=1e3),this.getFlagInterval&&clearInterval(this.getFlagInterval),this.getFlagInterval=setInterval(this.getFlags,t)},p.prototype.stopListening=function(){this.getFlagInterval&&(clearInterval(this.getFlagInterval),this.getFlagInterval=null)},p.prototype._loadedState=function(t,e,n){return void 0===t&&(t=null),void 0===n&&(n=!1),{error:t,isFetching:n,isLoading:!1,source:e}},p.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enableLogs&&console.log.apply(this,i(["FLAGSMITH:",(new Date).valueOf()-(this.timer||0),"ms"],t,!0))},p.prototype.updateStorage=function(){if(this.cacheFlags){this.ts=(new Date).valueOf();var t=JSON.stringify(this.getState());this.log("Setting storage",t),g.setItem(this.getStorageKey(),t)}},p.prototype.updateEventStorage=function(){if(this.enableAnalytics){var t=JSON.stringify(this.getState().evaluationEvent);g.setItem(h,t).catch((function(t){return console.error("Flagsmith: Error setting item in async storage",t)}))}},p.prototype.setLoadingState=function(e){var n;a(e,this.loadingState)||(this.loadingState=t({},e),this.log("Loading state changed",e),null===(n=this._triggerLoadingState)||void 0===n||n.call(this))},p.prototype.setupRealtime=function(t,e){var n=this,i=t+"sse/environments/"+e+"/stream";d?this.eventSource||(this.log("Creating event source with url "+i),this.eventSource=new d(i),this.eventSource.addEventListener("environment_updated",(function(t){var e;try{e=JSON.parse(t.data).updated_at}catch(t){n.log("Could not parse sse event",t)}e?!n.timestamp||e>n.timestamp?n.isLoading?n.log("updated_at is new, but flags are loading",t.data,n.timestamp):(n.log("updated_at is new, fetching flags",t.data,n.timestamp),n.getFlags()):n.log("updated_at is outdated, skipping get flags",t.data,n.timestamp):n.log("No updated_at received, fetching flags",t)}))):this.log("Error, EventSource is undefined")},p}();function y(t){var e=t.fetch,n=t.AsyncStorage,i=t.eventSource;return new p({fetch:e,AsyncStorage:n,eventSource:i})}var m=y({}),S=function(){return y({})};export{S as createFlagsmithInstance,m as default};
//# sourceMappingURL=next-middleware.mjs.map
